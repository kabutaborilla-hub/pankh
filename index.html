<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Pankh Restaurant & Cafe - Mansarovar, Jaipur</title>
    
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- === SUPABASE JS LIBRARY === -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- === END SUPABASE === -->

    <style>
        /* --- CORE DESIGN SYSTEM: Pankh Themes --- */
        /* 1. Default: Teal & Gold (Feather/Wing) */
        :root {
            --bg-color: #F8FAF5; /* Off-White/Creamy Background */
            --text-color: #1F2937; /* Dark Gray Text */
            --primary-color: #0F766E; /* Elegant Teal (Emerald 700) */
            --primary-text-color: #FFFFFF;
            --secondary-color: #D97706; /* Warm Gold (Amber 600) */
            --secondary-text-color: #FFFFFF;
            --accent-color: #c79a3a; /* Muted Gold for accents */
            --card-bg-color: #FFFFFF;
            --font-heading: 'Playfair Display', serif;
            --font-body: 'Inter', sans-serif;
        }

        /* 2. Theme: Midnight Rose (Dark Mode) */
        [data-theme="midnight"] {
            --bg-color: #111827; /* Dark Gray-Blue */
            --text-color: #E5E7EB; /* Light Gray */
            --primary-color: #F472B6; /* Bright Pink (Pink 400) */
            --primary-text-color: #111827;
            --secondary-color: #6366F1; /* Indigo (Indigo 500) */
            --secondary-text-color: #FFFFFF;
            --accent-color: #a75c80;
            --card-bg-color: #1F2937; /* Lighter dark */
        }
        
        /* 3. Theme: Royal Velvet (Elegant) */
        [data-theme="royal"] {
            --bg-color: #f5f3ff; /* Lavender white */
            --text-color: #1e1b4b; /* Deep Indigo */
            --primary-color: #7c3aed; /* Vibrant Violet */
            --primary-text-color: #FFFFFF;
            --secondary-color: #d946ef; /* Fuchsia */
            --secondary-text-color: #FFFFFF;
            --accent-color: #a855f7; /* Purple */
            --card-bg-color: #FFFFFF;
        }

        /* 4. Theme: Forest Trail (Earthy/Green) */
        [data-theme="forest"] {
            --bg-color: #f0fdf4; /* Very light green */
            --text-color: #14532d; /* Dark Green */
            --primary-color: #16a34a; /* Green 600 */
            --primary-text-color: #FFFFFF;
            --secondary-color: #ca8a04; /* Yellow 600 */
            --secondary-text-color: #FFFFFF;
            --accent-color: #65a30d; /* Lime 600 */
            --card-bg-color: #FFFFFF;
        }

        /* 5. Theme: Sunset Glow (Warm) */
        [data-theme="sunset"] {
            --bg-color: #fff7ed; /* Light Orange */
            --text-color: #431407; /* Dark Brown */
            --primary-color: #f97316; /* Orange 500 */
            --primary-text-color: #FFFFFF;
            --secondary-color: #ef4444; /* Red 500 */
            --secondary-text-color: #FFFFFF;
            --accent-color: #eab308; /* Yellow 500 */
            --card-bg-color: #FFFFFF;
        }
        
        /* 6. Theme: Ocean Breeze (Blue/Cool) */
        [data-theme="ocean"] {
            --bg-color: #f0f9ff; /* Light Sky Blue */
            --text-color: #0c4a6e; /* Dark Blue */
            --primary-color: #0ea5e9; /* Sky 500 */
            --primary-text-color: #FFFFFF;
            --secondary-color: #06b6d4; /* Cyan 500 */
            --secondary-text-color: #FFFFFF;
            --accent-color: #3b82f6; /* Blue 500 */
            --card-bg-color: #FFFFFF;
        }


        /* --- Base Styles --- */
        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: var(--font-body);
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        h1, h2, h3, h4, h5, h6 {
            font-family: var(--font-heading);
            color: var(--primary-color);
        }
        
        /* --- Utility Classes for Themes --- */
        .bg-primary { background-color: var(--primary-color); }
        .text-primary { color: var(--primary-color); }
        .text-primary-contrast { color: var(--primary-text-color); }
        
        .bg-secondary { background-color: var(--secondary-color); }
        .text-secondary { color: var(--secondary-color); }
        .text-secondary-contrast { color: var(--secondary-text-color); }
        
        .bg-accent { background-color: var(--accent-color); }
        .text-accent { color: var(--accent-color); }

        .bg-main { background-color: var(--bg-color); }
        .text-main { color: var(--text-color); }
        .bg-card { background-color: var(--card-bg-color); }
        
        .border-primary { border-color: var(--primary-color); }
        .border-secondary { border-color: var(--secondary-color); }
        .border-accent { border-color: var(--accent-color); }

        .ring-primary { --tw-ring-color: var(--primary-color); }
        .ring-secondary { --tw-ring-color: var(--secondary-color); }

        /* Custom focus ring color */
        .focus\:ring-primary:focus {
            --tw-ring-color: var(--primary-color);
        }
        
        .btn-primary {
            background-color: var(--primary-color);
            color: var(--primary-text-color);
            transition: all 0.2s ease-in-out;
        }
        .btn-primary:hover {
            filter: brightness(1.1);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .btn-primary:disabled {
            background-color: var(--accent-color);
            opacity: 0.7;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .btn-secondary {
            background-color: var(--secondary-color);
            color: var(--secondary-text-color);
            transition: all 0.2s ease-in-out;
        }
        .btn-secondary:hover {
            filter: brightness(1.1);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .btn-outline {
            background-color: transparent;
            color: var(--primary-color);
            border-color: var(--primary-color);
            transition: all 0.2s ease-in-out;
        }
        .btn-outline:hover {
            background-color: var(--primary-color);
            color: var(--primary-text-color);
        }

        .btn-ghost {
            background-color: transparent;
            color: var(--text-color);
            transition: all 0.2s ease-in-out;
        }
        .btn-ghost:hover {
            background-color: var(--primary-color);
            color: var(--primary-text-color);
        }
        .btn-ghost-secondary {
            background-color: transparent;
            color: var(--text-color);
            transition: all 0.2s ease-in-out;
        }
        .btn-ghost-secondary:hover {
            background-color: var(--secondary-color);
            color: var(--secondary-text-color);
        }

        /* --- Scrollbar --- */
        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }
        ::-webkit-scrollbar-track {
            background: var(--bg-color);
        }
        ::-webkit-scrollbar-thumb {
            background: var(--accent-color);
            border-radius: 5px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: var(--primary-color);
        }

        /* Horizontal scroll container */
        .horizontal-scroll-container {
            -ms-overflow-style: none; /* IE and Edge */
            scrollbar-width: none; /* Firefox */
        }
        .horizontal-scroll-container::-webkit-scrollbar {
            display: none; /* Chrome, Safari, Opera */
        }
        
        /* --- Component Styles --- */
        .category-tab.active {
            color: var(--primary-color);
            border-color: var(--primary-color);
            background-color: var(--card-bg-color);
        }
        .category-tab {
            color: var(--text-color);
            border-color: transparent;
        }

        /* Theme picker button */
        .theme-picker-btn {
            border: 2px solid transparent;
            transition: all 0.2s ease;
        }
        .theme-picker-btn.active {
            border-color: var(--primary-color);
            transform: scale(1.1);
        }
        
        /* Custom animation for cart icon */
        @keyframes cart-bump {
            0% { transform: scale(1); }
            50% { transform: scale(1.3); }
            100% { transform: scale(1); }
        }
        .cart-bump {
            animation: cart-bump 0.3s ease-out;
        }
        
        /* Custom animation for spin wheel result */
        @keyframes result-pop {
            0% { transform: scale(0.5); opacity: 0; }
            80% { transform: scale(1.1); opacity: 1; }
            100% { transform: scale(1); opacity: 1; }
        }
        .result-pop {
            animation: result-pop 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        /* Blur backdrop for modals */
        .backdrop-blur-sm {
            backdrop-filter: blur(4px);
            -webkit-backdrop-filter: blur(4px);
        }
        
        /* Intro Video Overlay */
        #intro-video-section {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1000;
            background-color: #000;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            cursor: pointer;
            transition: opacity 0.5s ease-out;
        }
        #intro-video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            position: absolute;
        }
        #intro-overlay {
            position: relative;
            z-index: 1001;
            text-align: center;
            background: rgba(0, 0, 0, 0.5);
            padding: 2rem;
            border-radius: 0.5rem;
        }
        #intro-overlay h1 {
            font-size: 3rem;
            color: #fff;
            margin-bottom: 1rem;
        }
        #intro-overlay p {
            font-size: 1.25rem;
            color: #eee;
        }

        /* Testimonial Slider */
        .testimonial-slide {
            transition: opacity 0.5s ease-in-out;
        }

        /* Heart icon animation */
        .heart-icon.favorited {
            fill: var(--secondary-color);
            color: var(--secondary-color);
            animation: heart-pop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        @keyframes heart-pop {
            0% { transform: scale(1); }
            50% { transform: scale(1.4); }
            100% { transform: scale(1); }
        }

    </style>
</head>
<body class="bg-main text-main transition-colors duration-300">

    <!-- ===== INTRO VIDEO OVERLAY ===== -->
    <section id="intro-video-section">
        <!-- Video from Pexels, by Mikhail Nilov -->
        <video id="intro-video" poster="https://placehold.co/1920x1080/000000/ffffff?text=Loading+Video..." playsinline autoplay muted loop>
             <source src="https://videos.pexels.com/video-files/7533339/7533339-hd_1920_1080_25fps.mp4" type="video/mp4">
             Your browser does not support the video tag.
        </video>
        <div id="intro-overlay">
            <h1 class="font-heading text-4xl sm:text-6xl text-white">The Pankh</h1>
            <p class="font-body text-lg sm:text-2xl text-gray-200">Click anywhere to enter</p>
        </div>
    </section>


    <!-- ===== HEADER & NAVIGATION ===== -->
    <header class="bg-card shadow-md sticky top-0 z-50">
        <nav class="container mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-20">
                <!-- Logo -->
                <div class="flex-shrink-0 flex items-center">
                    <svg class="h-10 w-10 text-primary" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 17c-1.16-1.16-2.84-2-5-2-2.16 0-3.84.84-5 2-1.16-1.16-2.84-2-5-2-2.16 0-3.84.84-5 2V7c1.16 1.16 2.84 2 5 2 2.16 0 3.84-.84 5-2 1.16 1.16 2.84 2 5 2 2.16 0 3.84-.84 5-2v10z"></path><path d="M22 17v-2"></path><path d="M17 15v-2"></path><path d="M12 17v-2"></path><path d="M7 15v-2"></path><path d="M2 17v-2"></path></svg>
                    <span class="ml-3 text-2xl font-bold font-heading text-primary">The Pankh</span>
                </div>
                
                <!-- Desktop Menu -->
                <div class="hidden sm:flex sm:items-center sm:space-x-4">
                    <a href="#home" class="text-main hover:text-primary transition-colors duration-200 font-medium px-2 py-1">Home</a>
                    <a href="#menu" class="text-main hover:text-primary transition-colors duration-200 font-medium px-2 py-1">Menu</a>
                    <a href="#about" class="text-main hover:text-primary transition-colors duration-200 font-medium px-2 py-1">About</a>
                    <a href="#contact" class="text-main hover:text-primary transition-colors duration-200 font-medium px-2 py-1">Contact</a>
                    
                    <!-- Loyalty Button -->
                    <button id="loyalty-button" class="flex items-center space-x-1 p-2 rounded-full btn-ghost-secondary" aria-label="Loyalty Points">
                        <i data-lucide="award" class="w-5 h-5"></i>
                        <span id="loyalty-points-display" class="text-sm font-semibold">0</span>
                    </button>

                    <!-- Cart Button -->
                    <button id="cart-button" class="relative p-2 rounded-full btn-ghost" aria-label="Open Cart">
                        <i data-lucide="shopping-cart" class="w-5 h-5"></i>
                        <span id="cart-count-badge" class="absolute -top-1 -right-1 bg-secondary text-secondary-contrast text-xs font-bold rounded-full h-5 w-5 flex items-center justify-center">0</span>
                    </button>

                    <!-- Settings (Theme) Button -->
                    <button id="settings-button" class="p-2 rounded-full btn-ghost" aria-label="Open Settings">
                        <i data-lucide="settings" class="w-5 h-5"></i>
                    </button>
                </div>
                
                <!-- Mobile Menu Button -->
                <div class="sm:hidden flex items-center">
                    <!-- Loyalty Button -->
                    <button id="mobile-loyalty-button" class="flex items-center space-x-1 p-2 rounded-full btn-ghost-secondary" aria-label="Loyalty Points">
                        <i data-lucide="award" class="w-5 h-5"></i>
                        <span id="mobile-loyalty-points-display" class="text-sm font-semibold">0</span>
                    </button>
                    <!-- Cart Button -->
                    <button id="mobile-cart-button" class="relative p-2 rounded-full btn-ghost" aria-label="Open Cart">
                        <i data-lucide="shopping-cart" class="w-5 h-5"></i>
                        <span id="mobile-cart-count-badge" class="absolute -top-1 -right-1 bg-secondary text-secondary-contrast text-xs font-bold rounded-full h-5 w-5 flex items-center justify-center">0</span>
                    </button>
                    <!-- Settings -->
                    <button id="mobile-settings-button" class="p-2 rounded-full btn-ghost" aria-label="Open Settings">
                        <i data-lucide="settings" class="w-5 h-5"></i>
                    </button>
                    <!-- Hamburger -->
                    <button id="mobile-menu-button" class="p-2 rounded-md btn-ghost" aria-label="Open Menu">
                        <i data-lucide="menu" id="mobile-menu-open-icon" class="w-5 h-5"></i>
                        <i data-lucide="x" id="mobile-menu-close-icon" class="hidden w-5 h-5"></i>
                    </button>
                </div>
            </div>
            
            <!-- Mobile Menu Panel -->
            <div id="mobile-menu" class="sm:hidden hidden pb-3 space-y-1">
                <a href="#home" class="block px-3 py-2 rounded-md text-base font-medium text-main hover:bg-primary hover:text-primary-contrast">Home</a>
                <a href="#menu" class="block px-3 py-2 rounded-md text-base font-medium text-main hover:bg-primary hover:text-primary-contrast">Menu</a>
                <a href="#about" class="block px-3 py-2 rounded-md text-base font-medium text-main hover:bg-primary hover:text-primary-contrast">About</a>
                <a href="#contact" class="block px-3 py-2 rounded-md text-base font-medium text-main hover:bg-primary hover:text-primary-contrast">Contact</a>
            </div>
        </nav>
    </header>

    <!-- ===== MAIN CONTENT ===== -->
    <main class="container mx-auto px-4 sm:px-6 lg:px-8 py-8">

        <!-- ===== HOME / HERO SECTION ===== -->
        <section id="home" class="pt-8 mb-16">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8 items-center">
                <!-- Hero Text -->
                <div>
                    <h1 class="text-4xl sm:text-5xl lg:text-6xl font-bold font-heading text-primary mb-6">
                        Experience Authentic Flavor
                    </h1>
                    <p class="text-lg sm:text-xl text-main mb-8">
                        Welcome to The Pankh, where traditional recipes meet modern ambiance. Discover a culinary journey that delights your senses.
                    </p>
                    <div class="flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-4">
                        <a href="#menu" class="px-8 py-3 rounded-lg btn-primary text-lg font-semibold shadow-lg text-center">Order Now</a>
                        <button id="open-booking-btn" class="px-8 py-3 rounded-lg btn-outline text-lg font-semibold border-2 text-center">Book a Table</button>
                    </div>
                    <button id="open-quick-order-btn" class="mt-4 w-full sm:w-auto px-6 py-2 rounded-lg btn-ghost-secondary text-base font-medium text-center inline-flex items-center justify-center">
                        <i data-lucide="zap" class="w-4 h-4 mr-2"></i>
                        Quick Order (Top 5)
                    </button>
                </div>
                
                <!-- Hero Image -->
                <div class="rounded-lg overflow-hidden shadow-2xl">
                    <img src="https://images.pexels.com/photos/1640777/pexels-photo-1640777.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=1" 
                         onerror="this.onerror=null;this.src='https://placehold.co/600x400/0F766E/FFFFFF?text=Delicious+Food'"
                         alt="Delicious salad bowl" 
                         class="w-full h-full object-cover aspect-video md:aspect-square">
                </div>
            </div>
        </section>
        
        <!-- ===== NEW: CHEF'S RECOMMENDATIONS ===== -->
        <section id="recommendations" class="mb-16">
            <h2 class="text-3xl sm:text-4xl font-bold font-heading text-primary mb-6">Chef's Specials</h2>
            <div class="flex overflow-x-auto space-x-6 pb-4 horizontal-scroll-container">
                <!-- Recommended items will be injected by JS -->
            </div>
        </section>

        <!-- ===== CALL TO ACTION / GAME CENTER ===== -->
        <section class="bg-card p-6 sm:p-8 rounded-lg shadow-lg mb-16 relative overflow-hidden">
            <div class="absolute -top-10 -right-10 w-32 h-32 bg-secondary rounded-full opacity-20"></div>
            <div class="absolute -bottom-12 -left-12 w-48 h-48 bg-primary rounded-full opacity-10"></div>
            
            <div class="relative z-10 flex flex-col md:flex-row justify-between items-center space-y-4 md:space-y-0">
                <div>
                    <h2 class="text-2xl sm:text-3xl font-bold font-heading text-primary mb-2">Feeling Lucky?</h2>
                    <p class="text-base sm:text-lg text-main">Spin the wheel to win an exclusive discount on your order today!</p>
                </div>
                <button id="open-game-center-btn" class="px-6 py-3 rounded-lg btn-secondary text-lg font-semibold shadow-lg animate-pulse">
                    <i data-lucide="gift" class="inline-block mr-2"></i>
                    Spin to Win!
                </button>
            </div>
        </section>

        <!-- ===== MENU SECTION ===== -->
        <section id="menu" class="pt-16 mb-16">
            <h2 class="text-3xl sm:text-4xl font-bold font-heading text-primary text-center mb-6">Our Menu</h2>
            
            <!-- NEW: Search Bar -->
            <div class="mb-8 max-w-lg mx-auto">
                <div class="relative">
                    <input id="menu-search-input" type="search" class="w-full pl-10 pr-4 py-3 rounded-lg border-2 border-gray-200 focus:outline-none focus:ring-2 focus:ring-primary bg-card" placeholder="Search our menu...">
                    <div class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400">
                        <i data-lucide="search" class="w-5 h-5"></i>
                    </div>
                </div>
            </div>

            <!-- NEW: Mobile Category Dropdown -->
            <div class="mb-8 sm:hidden">
                <label for="category-select" class="block text-sm font-medium text-main mb-1">Select Category</label>
                <select id="category-select" class="w-full p-3 rounded-lg border-2 border-gray-200 focus:outline-none focus:ring-2 focus:ring-primary bg-card text-main">
                    <!-- Options will be injected by JS -->
                </select>
            </div>

            <!-- Desktop Category Tabs -->
            <div class="hidden sm:flex justify-center mb-8 overflow-x-auto whitespace-nowrap pb-2 -mx-4 px-4">
                <div id="category-tabs" class="inline-flex space-x-2 sm:space-x-4 border-b-2 border-gray-200">
                    <!-- Tabs will be injected by JS -->
                </div>
            </div>
            
            <!-- Menu Items Grid -->
            <div id="menu-items-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 sm:gap-8">
                <!-- Menu items will be injected by JS -->
            </div>
        </section>

        <!-- ===== ABOUT SECTION ===== -->
        <section id="about" class="pt-16 mb-16">
            <h2 class="text-3xl sm:text-4xl font-bold font-heading text-primary text-center mb-12">Our Story</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8 sm:gap-12 items-center">
                <div class="rounded-lg overflow-hidden shadow-xl">
                    <img src="https://images.pexels.com/photos/1307698/pexels-photo-1307698.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=1" 
                         onerror="this.onerror=null;this.src='https://placehold.co/600x400/7c3aed/FFFFFF?text=Our+Ambiance'"
                         alt="Restaurant interior" 
                         class="w-full h-full object-cover aspect-video md:aspect-square">
                </div>
                <div class="prose prose-lg text-main max-w-none">
                    <p>
                        "Pankh," meaning "feather," symbolizes our mission to provide a light, uplifting, and delightful dining experience. 
                        Born from a passion for authentic Indian and continental cuisine, The Pankh Restaurant & Cafe was founded in the heart of Mansarovar, Jaipur, to be a sanctuary for food lovers.
                    </p>
                    <p>
                        Our chefs are artisans who meticulously craft each dish using the freshest local ingredients. We believe in food that not only tastes good but also tells a story. From our sizzling tandoori specials to our comforting pasta, every bite is an invitation to explore a world of flavor.
                    </p>
                    <p>
                        We are more than just a restaurant; we are a community hub. A place for first dates, family celebrations, and quiet afternoons with a cup of our signature spiced chai.
                    </p>
                </div>
            </div>
        </section>

        <!-- ===== NEW: TESTIMONIALS SECTION ===== -->
        <section id="testimonials" class="pt-16 mb-16">
            <h2 class="text-3xl sm:text-4xl font-bold font-heading text-primary text-center mb-12">What Our Guests Say</h2>
            <div class="bg-card p-6 sm:p-10 rounded-lg shadow-lg max-w-3xl mx-auto relative overflow-hidden">
                <div id="testimonial-container" class="relative h-48 flex items-center">
                    <!-- Testimonial slides will be injected by JS -->
                </div>
                <div class="absolute bottom-4 left-1/2 -translate-x-1/2 flex space-x-2">
                    <div id="testimonial-dot-1" class="testimonial-dot w-2 h-2 rounded-full bg-gray-300 transition-colors"></div>
                    <div id="testimonial-dot-2" class="testimonial-dot w-2 h-2 rounded-full bg-gray-300 transition-colors"></div>
                    <div id="testimonial-dot-3" class="testimonial-dot w-2 h-2 rounded-full bg-gray-300 transition-colors"></div>
                </div>
            </div>
        </section>


        <!-- ===== CONTACT SECTION ===== -->
        <section id="contact" class="pt-16 mb-8">
            <h2 class="text-3xl sm:text-4xl font-bold font-heading text-primary text-center mb-12">Get in Touch</h2>
            <div class="bg-card p-6 sm:p-8 rounded-lg shadow-lg max-w-4xl mx-auto">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <!-- Contact Info -->
                    <div class="space-y-6">
                        <div>
                            <h3 class="text-2xl font-heading font-semibold text-primary mb-3">Visit Us</h3>
                            <p class="text-lg text-main flex items-start">
                                <i data-lucide="map-pin" class="w-5 h-5 mr-3 mt-1 text-secondary flex-shrink-0"></i>
                                <span>1st Floor, 81/30-31, Madhyam Marg, Mansarovar, Jaipur, Rajasthan 302020</span>
                            </p>
                        </div>
                        <div>
                            <h3 class="text-2xl font-heading font-semibold text-primary mb-3">Call Us</h3>
                            <p class="text-lg text-main flex items-center">
                                <i data-lucide="phone" class="w-5 h-5 mr-3 text-secondary"></i>
                                <span>+91 98765 43210</span>
                            </p>
                        </div>
                        <div>
                            <h3 class="text-2xl font-heading font-semibold text-primary mb-3">Hours</h3>
                            <p class="text-lg text-main flex items-start">
                                <i data-lucide="clock" class="w-5 h-5 mr-3 mt-1 text-secondary"></i>
                                <span>
                                    <strong>Every Day</strong><br>
                                    11:00 AM - 11:00 PM
                                </span>
                            </p>
                        </div>
                    </div>
                    
                    <!-- Map -->
                    <div>
                        <iframe 
                            class="w-full h-80 rounded-lg shadow-md border-2 border-gray-200"
                            src="https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d3559.509890470501!2d75.76813181504368!3d26.85539508315181!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x396c4af5f5a2e8c9%3A0x8a7e58595c276f7!2sThe%20Pankh%20Restaurant%20%26%20Cafe!5e0!3m2!1sen!2sin!4v1678888888888!5m2!1sen!2sin" 
                            style="border:0;" 
                            allowfullscreen="" 
                            loading="lazy" 
                            referrerpolicy="no-referrer-when-downgrade">
                        </iframe>
                    </div>
                </div>
            </div>
        </section>

    </main>

    <!-- ===== FOOTER ===== -->
    <footer class="bg-card shadow-inner mt-16 border-t border-gray-200">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-8 text-center">
            <p class="text-main">&copy; <span id="footer-year">2024</span> The Pankh Restaurant & Cafe. All Rights Reserved.</p>
            <p class="text-sm text-gray-500 mt-2">Designed with <i data-lucide="heart" class="inline-block w-4 h-4 text-red-500 fill-current"></i> in Jaipur</p>
            
            <!-- Social Media Icons -->
            <div class="flex justify-center space-x-6 mt-4">
                <a href="#" class="text-gray-500 hover:text-primary transition-colors duration-200" aria-label="Facebook">
                    <i data-lucide="facebook" class="w-6 h-6"></i>
                </a>
                <a href="#" class="text-gray-500 hover:text-primary transition-colors duration-200" aria-label="Instagram">
                    <i data-lucide="instagram" class="w-6 h-6"></i>
                </a>
                <a href="#" class="text-gray-500 hover:text-primary transition-colors duration-200" aria-label="Twitter">
                    <i data-lucide="twitter" class="w-6 h-6"></i>
                </a>
            </div>
        </div>
    </footer>

    <!-- ===== MODALS ===== -->

    <!-- ===== CART MODAL ===== -->
    <div id="cart-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 backdrop-blur-sm hidden" aria-labelledby="cart-title" role="dialog" aria-modal="true">
        <div class="bg-card rounded-lg shadow-2xl w-full max-w-lg m-4 max-h-[90vh] flex flex-col">
            <!-- Modal Header -->
            <div class="flex justify-between items-center p-5 border-b border-gray-200">
                <h2 id="cart-title" class="text-2xl font-heading font-bold text-primary">Your Order</h2>
                <button id="close-cart-btn" class="p-2 rounded-full btn-ghost" aria-label="Close Cart">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            
            <!-- Order Type Toggle -->
            <div class="p-4 bg-gray-50 border-b border-gray-200">
                <div class="flex max-w-xs mx-auto rounded-lg p-1 bg-gray-200">
                    <button id="order-type-dine-in" class="order-type-btn flex-1 py-2 px-4 rounded-md text-sm font-semibold text-gray-700">
                        <i data-lucide="utensils" class="inline-block w-4 h-4 mr-1"></i> Dine-In
                    </button>
                    <button id="order-type-takeaway" class="order-type-btn flex-1 py-2 px-4 rounded-md text-sm font-semibold text-gray-700">
                        <i data-lucide="shopping-bag" class="inline-block w-4 h-4 mr-1"></i> Takeaway
                    </button>
                </div>
            </div>

            <!-- Cart Body -->
            <div id="cart-body" class="p-5 overflow-y-auto">
                <div id="empty-cart-message" class="text-center text-gray-500 py-8">
                    <i data-lucide="shopping-cart" class="w-16 h-16 mx-auto mb-4 text-gray-300"></i>
                    <p class="text-lg">Your cart is empty.</p>
                    <p class="text-sm">Add items from the menu to get started.</p>
                </div>
                <div id="cart-items-container"></div>
            </div>
            
            <!-- Cart Footer -->
            <div id="cart-footer" class="p-5 border-t border-gray-200 mt-auto space-y-4">
                <!-- NEW: Loyalty Points Redemption -->
                <div id="loyalty-redeem-section" class="hidden">
                    <p class="text-sm text-center text-main mb-2">You have <strong id="redeem-points-available">0</strong> loyalty points.</p>
                    <button id="redeem-points-btn" class="w-full px-4 py-2 rounded-lg btn-outline text-sm font-semibold border-2">
                        Redeem Points for <span id="redeem-points-value">₹0</span> Discount
                    </button>
                </div>

                <!-- Discount Section -->
                <div id="discount-applied-section" class="hidden">
                    <div class="flex justify-between items-center text-green-600 font-semibold bg-green-50 p-3 rounded-lg">
                        <span class="flex items-center">
                            <i data-lucide="party-popper" class="w-5 h-5 mr-2"></i>
                            <span id="discount-text">Discount Applied!</span>
                        </span>
                        <span id="discount-amount-display">- ₹0.00</span>
                    </div>
                </div>

                <!-- NEW: Redeemed Points Display -->
                <div id="points-redeemed-section" class="hidden">
                    <div class="flex justify-between items-center text-blue-600 font-semibold bg-blue-50 p-3 rounded-lg">
                        <span class="flex items-center">
                            <i data-lucide="award" class="w-5 h-5 mr-2"></i>
                            <span id="points-redeemed-text">Points Redeemed</span>
                        </span>
                        <span id="points-redeemed-amount-display">- ₹0.00</span>
                    </div>
                </div>
                
                <!-- Totals -->
                <div class="space-y-2 text-lg">
                    <div class="flex justify-between">
                        <span class="text-main font-medium">Subtotal</span>
                        <span id="cart-subtotal" class="font-semibold text-main">₹0.00</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-main font-medium">Taxes (5%)</span>
                        <span id="cart-taxes" class="font-semibold text-main">₹0.00</span>
                    </div>
                    <div class="flex justify-between text-xl font-bold text-primary">
                        <span>Total</span>
                        <span id="cart-total">₹0.00</span>
                    </div>
                </div>
                
                <!-- Action Button -->
                <button id="checkout-btn" class="w-full px-6 py-4 rounded-lg btn-primary text-lg font-semibold shadow-lg">
                    Place Order
                </button>
            </div>
        </div>
    </div>
    
    <!-- ===== GAME CENTER MODAL ===== -->
    <div id="game-center-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 backdrop-blur-sm hidden" role="dialog" aria-modal="true">
        <div class="bg-card rounded-lg shadow-2xl w-full max-w-md m-4 p-6 relative">
            <button id="close-game-center-btn" class="absolute top-3 right-3 p-2 rounded-full btn-ghost" aria-label="Close Game Center">
                <i data-lucide="x" class="w-6 h-6"></i>
            </button>
            <h2 class="text-3xl font-heading font-bold text-primary text-center mb-6">Spin the Wheel!</h2>
            <div id="wheel-container" class="relative flex justify-center items-center mb-6">
                <div id="spin-wheel" class="relative w-72 h-72 sm:w-80 sm:h-80 rounded-full border-8 border-secondary shadow-xl overflow-hidden transition-transform duration-[5000ms] ease-out">
                    <!-- Segments will be added by JS -->
                </div>
                <div class="absolute -top-2 w-0 h-0 border-l-8 border-l-transparent border-r-8 border-r-transparent border-t-[20px] border-t-red-600 z-10" style="left: calc(50% - 8px);"></div>
                <div class="absolute w-12 h-12 bg-card rounded-full flex items-center justify-center border-4 border-secondary shadow-inner" style="top: calc(50% - 24px); left: calc(50% - 24px);">
                    <i data-lucide="gift" class="w-6 h-6 text-secondary"></i>
                </div>
            </div>
            <button id="spin-btn" class="w-full px-6 py-4 rounded-lg btn-secondary text-lg font-semibold shadow-lg transition-all">
                Spin Now!
            </button>
            <div id="spin-result" class="hidden text-center mt-6 p-4 rounded-lg bg-green-50 border border-green-200">
                <h3 class="text-2xl font-heading font-bold text-green-700">Congratulations!</h3>
                <p class="text-lg text-green-600">You won a <strong id="result-text">10% discount</strong>!</p>
            </div>
            <div id="already-spun" class="hidden text-center mt-6 p-4 rounded-lg bg-blue-50 border border-blue-200">
                <h3 class="text-2xl font-heading font-bold text-blue-700">Already Redeemed!</h3>
                <p class="text-lg text-blue-600">You've already used your spin for today. Your <strong id="existing-discount-text">10% discount</strong> is active.</p>
            </div>
        </div>
    </div>

    <!-- ===== NEW: LOYALTY MODAL ===== -->
    <div id="loyalty-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 backdrop-blur-sm hidden" role="dialog" aria-modal="true">
        <div class="bg-card rounded-lg shadow-2xl w-full max-w-md m-4 p-6 relative">
            <button id="close-loyalty-btn" class="absolute top-3 right-3 p-2 rounded-full btn-ghost" aria-label="Close Loyalty">
                <i data-lucide="x" class="w-6 h-6"></i>
            </button>
            <div class="text-center">
                <i data-lucide="award" class="w-16 h-16 mx-auto mb-4 text-secondary"></i>
                <h2 class="text-3xl font-heading font-bold text-primary text-center mb-4">Your Loyalty Points</h2>
                <p class="text-6xl font-bold text-secondary mb-4" id="loyalty-modal-points">0</p>
                <p class="text-lg text-main mb-2">You are a <strong>Guest Member</strong>.</p>
                <p class="text-main mb-6">Earn <strong>10 points</strong> for every <strong>₹100</strong> spent. <br> <strong>1 point = ₹1</strong> discount on your next order.</p>
                <p class="text-sm text-gray-500">Loyalty points are saved on this device. Login for cross-device access (coming soon!).</p>
            </div>
        </div>
    </div>

    <!-- ===== NEW: SETTINGS MODAL (for Theme) ===== -->
    <div id="settings-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 backdrop-blur-sm hidden" role="dialog" aria-modal="true">
        <div class="bg-card rounded-lg shadow-2xl w-full max-w-md m-4 p-6 relative">
            <button id="close-settings-btn" class="absolute top-3 right-3 p-2 rounded-full btn-ghost" aria-label="Close Settings">
                <i data-lucide="x" class="w-6 h-6"></i>
            </button>
            <h2 class="text-3xl font-heading font-bold text-primary text-center mb-6">App Settings</h2>
            
            <h3 class="text-xl font-heading font-semibold text-primary mb-4">Choose Theme</h3>
            <div id="theme-picker-container" class="grid grid-cols-3 gap-4">
                <!-- Theme buttons will be injected by JS -->
            </div>
            
            <h3 class="text-xl font-heading font-semibold text-primary mt-8 mb-4">Dark Mode</h3>
            <button id="theme-toggle-btn" class="w-full flex justify-between items-center p-3 rounded-lg bg-gray-100 dark:bg-gray-700">
                <span class="font-medium text-main">Toggle Dark Mode</span>
                <span class="relative">
                    <i data-lucide="sun" id="theme-icon-sun"></i>
                    <i data-lucide="moon" id="theme-icon-moon" class="hidden"></i>
                </span>
            </button>
        </div>
    </div>
    
    <!-- ===== NEW: BOOKING MODAL ===== -->
    <div id="booking-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 backdrop-blur-sm hidden" role="dialog" aria-modal="true">
        <div class="bg-card rounded-lg shadow-2xl w-full max-w-md m-4 p-6 relative">
            <button id="close-booking-btn" class="absolute top-3 right-3 p-2 rounded-full btn-ghost" aria-label="Close Booking Form">
                <i data-lucide="x" class="w-6 h-6"></i>
            </button>
            <h2 class="text-3xl font-heading font-bold text-primary text-center mb-6">Book a Table</h2>
            <form id="booking-form" class="space-y-4">
                <div>
                    <label for="book-name" class="block text-sm font-medium text-main mb-1">Name</label>
                    <input type="text" id="book-name" required class="w-full p-3 rounded-lg border-2 border-gray-200 focus:outline-none focus:ring-2 focus:ring-primary bg-card" placeholder="Your Full Name">
                </div>
                <div>
                    <label for="book-phone" class="block text-sm font-medium text-main mb-1">Phone</label>
                    <input type="tel" id="book-phone" required class="w-full p-3 rounded-lg border-2 border-gray-200 focus:outline-none focus:ring-2 focus:ring-primary bg-card" placeholder="98765 43210">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="book-guests" class="block text-sm font-medium text-main mb-1">Guests</label>
                        <input type="number" id="book-guests" required class="w-full p-3 rounded-lg border-2 border-gray-200 focus:outline-none focus:ring-2 focus:ring-primary bg-card" min="1" max="20" value="2">
                    </div>
                    <div>
                        <label for="book-date" class="block text-sm font-medium text-main mb-1">Date</label>
                        <input type="date" id="book-date" required class="w-full p-3 rounded-lg border-2 border-gray-200 focus:outline-none focus:ring-2 focus:ring-primary bg-card">
                    </div>
                </div>
                <button type="submit" class="w-full px-6 py-3 rounded-lg btn-primary text-lg font-semibold shadow-lg">
                    Request Booking
                </button>
            </form>
        </div>
    </div>
    
    <!-- ===== NEW: QUICK ORDER MODAL ===== -->
    <div id="quick-order-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 backdrop-blur-sm hidden" role="dialog" aria-modal="true">
        <div class="bg-card rounded-lg shadow-2xl w-full max-w-lg m-4 max-h-[90vh] flex flex-col">
            <div class="flex justify-between items-center p-5 border-b border-gray-200">
                <h2 class="text-2xl font-heading font-bold text-primary">Quick Order (Top Picks)</h2>
                <button id="close-quick-order-btn" class="p-2 rounded-full btn-ghost" aria-label="Close Quick Order">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            <div id="quick-order-body" class="p-5 overflow-y-auto space-y-3">
                <!-- Quick order items injected by JS -->
            </div>
        </div>
    </div>
    
    <!-- ===== NEW: MENU ITEM DETAIL MODAL ===== -->
    <div id="menu-item-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 backdrop-blur-sm hidden" role="dialog" aria-modal="true">
        <div class="bg-card rounded-lg shadow-2xl w-full max-w-md m-4 max-h-[90vh] flex flex-col">
            <div class="relative">
                <img id="menu-item-modal-img" src="https://placehold.co/600x400/0F766E/FFFFFF?text=Pankh+Special" alt="Menu Item" class="w-full h-48 object-cover rounded-t-lg">
                <button id="close-menu-item-btn" class="absolute top-3 right-3 p-2 rounded-full bg-black bg-opacity-40 text-white hover:bg-opacity-60" aria-label="Close Item Details">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
                <button id="menu-item-modal-fav-btn" class="absolute top-3 left-3 p-2 rounded-full bg-black bg-opacity-40 text-white hover:bg-opacity-60" aria-label="Add to Favorites">
                    <i data-lucide="heart" class="w-5 h-5 heart-icon"></i>
                </button>
            </div>
            <div class="p-6 flex-grow flex flex-col">
                <div class="flex justify-between items-start mb-2">
                    <h2 id="menu-item-modal-name" class="text-2xl font-heading font-bold text-primary">Menu Item Name</h2>
                    <img id="menu-item-modal-veg" src="https://upload.wikimedia.org/wikipedia/commons/thumb/b/b2/Veg_symbol.svg/1200px-Veg_symbol.svg.png" alt="Veg" class="w-6 h-6 ml-2">
                </div>
                <p id="menu-item-modal-desc" class="text-main mb-4 flex-grow">Item description goes here, making it sound as delicious as possible.</p>
                <div class="flex justify-between items-center mt-auto">
                    <span id="menu-item-modal-price" class="text-2xl font-bold text-primary">₹0.00</span>
                    <button id="menu-item-modal-add-btn" class="px-6 py-3 rounded-lg btn-secondary font-semibold">
                        Add to Cart
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ===== CUSTOM TOAST/MESSAGE MODAL ===== -->
    <div id="message-modal" class="fixed top-5 right-5 z-[1001] bg-card shadow-2xl rounded-lg p-5 w-full max-w-sm border-l-4 transition-transform translate-x-[150%] duration-300 ease-out" role="alert">
        <div class="flex items-center">
            <div id="message-icon-container" class="mr-3">
                <!-- Icon will be injected here -->
            </div>
            <div class="flex-1">
                <h3 id="message-title" class="text-lg font-semibold font-heading">Success!</h3>
                <p id="message-body" class="text-main">Item added to cart.</p>
            </div>
            <button id="close-message-btn" class="ml-3 p-1 rounded-full text-gray-400 hover:bg-gray-100" aria-label="Close message">
                <i data-lucide="x" class="w-5 h-5"></i>
            </button>
        </div>
    </div>


    <!-- ===== MAIN APPLICATION SCRIPT ===== -->
    <script type="module">
        // === SUPABASE CLIENT INITIALIZATION ===
        const SUPABASE_URL = 'https://seygsmqucuvnialnuqdv.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNleWdzbXF1Y3V2bmlhbG51cWR2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEzODY1ODMsImV4cCI6MjA3Njk2MjU4M30.5iXFdlkDHVKRjHBTqUiI1SrRpItoLbrTsZVe-9ETiII';
        
        let supabase = null;
        try {
            const { createClient } = window.supabase;
            supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            console.log("Supabase client initialized successfully.");
        } catch (e) {
            console.error("Error initializing Supabase:", e);
        }
        // === END SUPABASE INITIALIZATION ===
        

        // === APPLICATION LOGIC ===
        document.addEventListener('DOMContentLoaded', () => {
    
            // --- Database ---
            const menuData = [
                // ... (Original menuData array remains unchanged)
                { id: 1, name: "Pankh Special Paneer Tikka", category: "Appetizers", price: 280, veg: true, description: "Creamy paneer cubes marinated in a special spice blend, grilled to perfection.", popular: true },
                { id: 2, name: "Murgh Malai Kebab", category: "Appetizers", price: 350, veg: false, description: "Tender chicken kebabs in a creamy cashew and cheese marinade." },
                { id: 3, name: "Dahi Ke Kebab", category: "Appetizers", price: 250, veg: true, description: "Soft, melt-in-your-mouth kebabs made from hung curd and spices." },
                { id: 4, name: "Chilli Paneer Dry", category: "Appetizers", price: 270, veg: true, description: "Classic Indo-Chinese starter with crispy paneer tossed in a spicy sauce." },
                { id: 5, name: "Crispy Corn", category: "Appetizers", price: 220, veg: true, description: "Sweet corn kernels, fried crispy and tossed with onions, peppers, and spices.", popular: true },
                
                { id: 6, name: "Dal Makhani", category: "Main Course", price: 320, veg: true, description: "Creamy and rich black lentils slow-cooked overnight with butter and cream.", popular: true },
                { id: 7, name: "Paneer Butter Masala", category: "Main Course", price: 350, veg: true, description: "Soft paneer in a luscious tomato, butter, and cashew gravy." },
                { id: 8, name: "Kadhai Paneer", category: "Main Course", price: 340, veg: true, description: "Paneer and bell peppers cooked in a spicy, freshly ground masala." },
                { id: 9, name: "Butter Chicken", category: "Main Course", price: 450, veg: false, description: "The timeless classic. Grilled chicken in a smooth buttery and creamy tomato gravy.", popular: true },
                { id: 10, name: "Laal Maas", category: "Main Course", price: 550, veg: false, description: "A fiery Rajasthani mutton curry with a rich, red gravy." },
                { id: 11, name: "Malai Kofta", category: "Main Course", price: 360, veg: true, description: "Deep-fried paneer and potato balls in a rich, creamy, and mildly sweet gravy." },
                
                { id: 12, name: "Pankh Special Thali", category: "Thali", price: 400, veg: true, description: "A grand platter with Dal Makhani, Shahi Paneer, Mix Veg, Raita, Rice, 2 Roti, Salad, and Gulab Jamun." },
                { id: 13, name: "Rajasthani Thali", category: "Thali", price: 420, veg: true, description: "Dal Baati Churma, Gatte ki Sabzi, Ker Sangri, Raita, Rice, 2 Baati, Salad, and a sweet." },

                { id: 14, name: "Garlic Naan", category: "Breads", price: 70, veg: true, description: "Soft Indian bread topped with chopped garlic and butter." },
                { id: 15, name: "Butter Roti", category: "Breads", price: 40, veg: true, description: "Whole wheat bread cooked in a tandoor and brushed with butter." },
                { id: 16, name: "Lachha Paratha", category: "Breads", price: 60, veg: true, description: "Crispy, multi-layered whole wheat bread." },

                { id: 17, name: "Veg Biryani", category: "Rice", price: 280, veg: true, description: "Aromatic basmati rice cooked with mixed vegetables and fragrant spices, served with raita." },
                { id: 18, name: "Chicken Biryani", category: "Rice", price: 380, veg: false, description: "Flavorful biryani with tender chicken pieces, cooked dum-style, served with raita." },
                { id: 19, name: "Jeera Rice", category: "Rice", price: 180, veg: true, description: "Basmati rice tempered with cumin seeds and ghee." },

                { id: 20, name: "Arrabbiata Pasta", category: "Continental", price: 300, veg: true, description: "Penne pasta in a spicy tomato and basil sauce, with exotic vegetables." },
                { id: 21, name: "Alfredo Pasta", category: "Continental", price: 320, veg: true, description: "Creamy white sauce pasta with mushrooms and herbs. (Add Chicken optional)" },
                { id: 22, name: "Pankh Club Sandwich", category: "Continental", price: 250, veg: true, description: "A triple-layered sandwich with fresh veggies, cheese, and a special sauce." },
                { id: 23, name: "Margherita Pizza", category: "Continental", price: 350, veg: true, description: "Classic 10-inch pizza with tomato, basil, and mozzarella." },
                
                { id: 24, name: "Virgin Mojito", category: "Drinks", price: 180, veg: true, description: "A refreshing muddle of mint, lemon, and sparkling water.", popular: true },
                { id: 25, name: "KitKat Shake", category: "Drinks", price: 220, veg: true, description: "A thick, creamy shake blended with real KitKat bars." },
                { id: 26, name: "Masala Chai", category: "Drinks", price: 80, veg: true, description: "Traditional Indian spiced tea, a perfect companion." },
                
                { id: 27, name: "Gulab Jamun", category: "Desserts", price: 120, veg: true, description: "Two pieces of soft, warm gulab jamun in sweet syrup." },
                { id: 28, name: "Sizzling Brownie", category: "Desserts", price: 250, veg: true, description: "A sizzling hot brownie topped with vanilla ice cream and chocolate sauce." },
            ];

            const categories = ['Favorites', ...new Set(menuData.map(item => item.category))];
            
            const spinWheelSegments = [
                // ... (Original spinWheelSegments array remains unchanged)
                { label: "10% OFF", value: 10 },
                { label: "Try Again", value: 0 },
                { label: "15% OFF", value: 15 },
                { label: "5% OFF", value: 5 },
                { label: "Try Again", value: 0 },
                { label: "20% OFF", value: 20 },
                { label: "Try Again", value: 0 },
                { label: "10% OFF", value: 10 }
            ];
            const segmentColors = [
                // ... (Original segmentColors array remains unchanged)
                "var(--primary-color)", 
                "var(--secondary-color)", 
                "var(--accent-color)",
                "#34d399" /* Emerald 400 */,
                "var(--primary-color)", 
                "var(--secondary-color)", 
                "var(--accent-color)",
                "#34d399" /* Emerald 400 */
            ];

            const appThemes = [
                // ... (Theme data for the new picker)
                { id: 'teal', name: 'Teal & Gold', color: '#0F766E' },
                { id: 'royal', name: 'Royal Velvet', color: '#7c3aed' },
                { id: 'forest', name: 'Forest Trail', color: '#16a34a' },
                { id: 'sunset', name: 'Sunset Glow', color: '#f97316' },
                { id: 'ocean', name: 'Ocean Breeze', color: '#0ea5e9' }
                // Note: 'midnight' (dark) is handled by the toggle
            ];
            
            const testimonials = [
                // ... (Data for new testimonial slider)
                { name: "Ananya S.", quote: "Absolutely magical ambiance and the Dal Makhani is to die for! My new favorite spot in Mansarovar." },
                { name: "Rohan V.", quote: "The Pankh Special Thali was huge and every single dish was delicious. 10/10 value for money." },
                { name: "Priya K.", quote: "Loved the pasta and the Virgin Mojito was so refreshing. Great service and beautiful decor!" }
            ];

            // --- State Variables ---
            let cart = []; // { id, name, price, quantity, veg }
            let currentTheme = 'teal'; 
            let orderType = 'Dine-In'; 
            let spinDiscount = null; // { value: 10, text: "10% OFF" }
            let isSpinning = false;
            let loyaltyPoints = 0; // NEW: Loyalty
            let favorites = []; // NEW: Favorites
            let pointsRedeemed = 0; // NEW: Track redeemed points for this transaction
            let currentCategory = categories[0]; // NEW: Track current category
            let currentTestimonial = 0; // NEW: Testimonial index
            let testimonialInterval; // NEW: Testimonial timer

            // --- Element Selectors ---
            const categoryTabsContainer = document.getElementById('category-tabs');
            const categorySelect = document.getElementById('category-select'); // NEW
            const menuSearchInput = document.getElementById('menu-search-input'); // NEW
            const menuItemsGrid = document.getElementById('menu-items-grid');
            
            const cartButton = document.getElementById('cart-button');
            const mobileCartButton = document.getElementById('mobile-cart-button');
            const cartModal = document.getElementById('cart-modal');
            const closeCartBtn = document.getElementById('close-cart-btn');
            const cartItemsContainer = document.getElementById('cart-items-container');
            const emptyCartMessage = document.getElementById('empty-cart-message');
            const cartFooter = document.getElementById('cart-footer');
            const cartSubtotalEl = document.getElementById('cart-subtotal');
            const cartTaxesEl = document.getElementById('cart-taxes');
            const cartTotalEl = document.getElementById('cart-total');
            const checkoutBtn = document.getElementById('checkout-btn');
            const cartCountBadges = document.querySelectorAll('#cart-count-badge, #mobile-cart-count-badge');
            
            const orderTypeDineInBtn = document.getElementById('order-type-dine-in');
            const orderTypeTakeawayBtn = document.getElementById('order-type-takeaway');
            
            const discountAppliedSection = document.getElementById('discount-applied-section');
            const discountTextEl = document.getElementById('discount-text');
            const discountAmountDisplayEl = document.getElementById('discount-amount-display');

            const themeToggleBtn = document.getElementById('theme-toggle-btn');
            const mobileThemeToggleBtn = document.getElementById('mobile-theme-toggle-btn'); // This is now in settings modal
            
            const mobileMenuButton = document.getElementById('mobile-menu-button');
            const mobileMenu = document.getElementById('mobile-menu');
            const mobileMenuOpenIcon = document.getElementById('mobile-menu-open-icon');
            const mobileMenuCloseIcon = document.getElementById('mobile-menu-close-icon');
            
            const introVideoSection = document.getElementById('intro-video-section');
            const introVideo = document.getElementById('intro-video');

            const gameCenterBtn = document.getElementById('open-game-center-btn');
            const gameCenterModal = document.getElementById('game-center-modal');
            const closeGameCenterBtn = document.getElementById('close-game-center-btn');
            const spinWheel = document.getElementById('spin-wheel');
            const spinBtn = document.getElementById('spin-btn');
            const spinResult = document.getElementById('spin-result');
            const resultText = document.getElementById('result-text');
            const alreadySpun = document.getElementById('already-spun');
            const existingDiscountText = document.getElementById('existing-discount-text');

            // NEW: Loyalty Selectors
            const loyaltyButtons = document.querySelectorAll('#loyalty-button, #mobile-loyalty-button');
            const loyaltyPointsDisplays = document.querySelectorAll('#loyalty-points-display, #mobile-loyalty-points-display');
            const loyaltyModal = document.getElementById('loyalty-modal');
            const closeLoyaltyBtn = document.getElementById('close-loyalty-btn');
            const loyaltyModalPoints = document.getElementById('loyalty-modal-points');
            const loyaltyRedeemSection = document.getElementById('loyalty-redeem-section');
            const redeemPointsBtn = document.getElementById('redeem-points-btn');
            const redeemPointsAvailable = document.getElementById('redeem-points-available');
            const redeemPointsValue = document.getElementById('redeem-points-value');
            const pointsRedeemedSection = document.getElementById('points-redeemed-section');
            const pointsRedeemedAmountDisplay = document.getElementById('points-redeemed-amount-display');

            // NEW: Settings Modal Selectors
            const settingsButtons = document.querySelectorAll('#settings-button, #mobile-settings-button');
            const settingsModal = document.getElementById('settings-modal');
            const closeSettingsBtn = document.getElementById('close-settings-btn');
            const themePickerContainer = document.getElementById('theme-picker-container');
            // Re-using themeToggleBtn for the one inside the modal now
            
            // NEW: Booking Modal Selectors
            const openBookingBtn = document.getElementById('open-booking-btn');
            const bookingModal = document.getElementById('booking-modal');
            const closeBookingBtn = document.getElementById('close-booking-btn');
            const bookingForm = document.getElementById('booking-form');

            // NEW: Quick Order Modal Selectors
            const openQuickOrderBtn = document.getElementById('open-quick-order-btn');
            const quickOrderModal = document.getElementById('quick-order-modal');
            const closeQuickOrderBtn = document.getElementById('close-quick-order-btn');
            const quickOrderBody = document.getElementById('quick-order-body');
            
            // NEW: Menu Item Modal Selectors
            const menuItemModal = document.getElementById('menu-item-modal');
            const closeMenuItemBtn = document.getElementById('close-menu-item-btn');
            const menuItemModalImg = document.getElementById('menu-item-modal-img');
            const menuItemModalFavBtn = document.getElementById('menu-item-modal-fav-btn');
            const menuItemModalName = document.getElementById('menu-item-modal-name');
            const menuItemModalVeg = document.getElementById('menu-item-modal-veg');
            const menuItemModalDesc = document.getElementById('menu-item-modal-desc');
            const menuItemModalPrice = document.getElementById('menu-item-modal-price');
            const menuItemModalAddBtn = document.getElementById('menu-item-modal-add-btn');
            
            // NEW: Recommendations Selector
            const recommendationsContainer = document.querySelector('#recommendations .horizontal-scroll-container');
            
            // NEW: Testimonials Selectors
            const testimonialContainer = document.getElementById('testimonial-container');

            // Message Modal
            const messageModal = document.getElementById('message-modal');
            const messageIconContainer = document.getElementById('message-icon-container');
            const messageTitle = document.getElementById('message-title');
            const messageBody = document.getElementById('message-body');
            const closeMessageBtn = document.getElementById('close-message-btn');
            let messageTimer;

            // --- Theme Management ---
            function applyTheme(theme) {
                const html = document.documentElement;
                const sunIcons = document.querySelectorAll('#theme-icon-sun');
                const moonIcons = document.querySelectorAll('#theme-icon-moon');
                
                // Clear all themes
                appThemes.forEach(t => html.removeAttribute('data-theme', t.id));
                html.removeAttribute('data-theme', 'midnight');
                
                // Set new theme
                if (theme === 'dark') {
                    html.setAttribute('data-theme', 'midnight');
                    sunIcons.forEach(icon => icon.classList.add('hidden'));
                    moonIcons.forEach(icon => icon.classList.remove('hidden'));
                } else {
                    if(theme !== 'teal') {
                        html.setAttribute('data-theme', theme);
                    }
                    sunIcons.forEach(icon => icon.classList.remove('hidden'));
                    moonIcons.forEach(icon => icon.classList.add('hidden'));
                }
                currentTheme = theme;
                localStorage.setItem('pankhTheme', theme);
                
                // Re-render wheel for new theme colors
                renderSpinWheel();
                updateThemePickerUI();
            }

            function toggleTheme() {
                if (currentTheme === 'dark') {
                    applyTheme(localStorage.getItem('pankhLightTheme') || 'teal'); // Revert to last light theme
                } else {
                    localStorage.setItem('pankhLightTheme', currentTheme); // Remember last light theme
                    applyTheme('dark'); 
                }
            }
            
            function renderThemePicker() {
                themePickerContainer.innerHTML = '';
                appThemes.forEach(theme => {
                    const btn = document.createElement('button');
                    btn.className = 'theme-picker-btn p-2 rounded-lg flex flex-col items-center';
                    btn.dataset.theme = theme.id;
                    btn.innerHTML = `
                        <span class="w-10 h-10 rounded-full mb-2" style="background-color: ${theme.color};"></span>
                        <span class="text-sm font-medium text-main">${theme.name}</span>
                    `;
                    btn.addEventListener('click', () => {
                        applyTheme(theme.id);
                    });
                    themePickerContainer.appendChild(btn);
                });
                updateThemePickerUI();
            }
            
            function updateThemePickerUI() {
                document.querySelectorAll('.theme-picker-btn').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.theme === currentTheme);
                });
            }

            // --- Intro Video ---
            function playIntro() {
                // ... (Original playIntro function remains unchanged)
                introVideo.play().catch(error => {
                    console.warn("Video autoplay was prevented. User interaction is needed.", error);
                });
                introVideoSection.style.opacity = '0';
                setTimeout(() => {
                    introVideoSection.style.display = 'none';
                }, 500); 
            }

            // --- Render Functions ---
            function renderMenu() {
                categoryTabsContainer.innerHTML = '';
                categorySelect.innerHTML = '';
                
                categories.forEach((category, index) => {
                    // 1. Render Desktop Tabs
                    const tab = document.createElement('button');
                    tab.className = `category-tab px-4 py-2 font-semibold text-lg border-b-2 transition-all duration-200 ${index === 0 ? 'active' : ''}`;
                    tab.textContent = category;
                    if (category === 'Favorites') {
                        tab.innerHTML += ` <i data-lucide="heart" class="inline-block w-4 h-4 text-secondary"></i>`;
                    }
                    tab.dataset.category = category;
                    tab.addEventListener('click', () => setCategory(category));
                    categoryTabsContainer.appendChild(tab);
                    
                    // 2. Render Mobile Options
                    const option = document.createElement('option');
                    option.value = category;
                    option.textContent = category;
                    if (index === 0) option.selected = true;
                    categorySelect.appendChild(option);
                });
                
                // 3. Render Menu Items (start with first category)
                currentCategory = categories[0];
                filterMenu();
            }

            function setCategory(category) {
                currentCategory = category;
                // Update Tab Active State
                document.querySelectorAll('.category-tab').forEach(tab => {
                    tab.classList.toggle('active', tab.dataset.category === category);
                });
                // Update Select Active State
                categorySelect.value = category;
                // Re-filter
                filterMenu();
            }
            
            function filterMenu() {
                // 1. Get search term
                const searchTerm = menuSearchInput.value.toLowerCase();

                // 2. Filter by category
                let itemsToRender = [];
                if (currentCategory === 'Favorites') {
                    itemsToRender = menuData.filter(item => favorites.includes(item.id));
                } else {
                    itemsToRender = menuData.filter(item => item.category === currentCategory);
                }
                
                // 3. Filter by search
                if (searchTerm) {
                    itemsToRender = itemsToRender.filter(item => 
                        item.name.toLowerCase().includes(searchTerm) ||
                        item.description.toLowerCase().includes(searchTerm)
                    );
                }

                // 4. Render Items
                menuItemsGrid.innerHTML = '';
                if (itemsToRender.length === 0) {
                    menuItemsGrid.innerHTML = `<p class="text-center text-gray-500 sm:col-span-2 lg:col-span-3">No items found.</p>`;
                    if (currentCategory === 'Favorites' && searchTerm === '') {
                        menuItemsGrid.innerHTML = `<p class="text-center text-gray-500 sm:col-span-2 lg:col-span-3">You haven't added any favorites yet. Click the <i data-lucide="heart" class="inline-block w-4 h-4"></i> on an item to add it!</p>`;
                    }
                }
                
                itemsToRender.forEach(item => {
                    const itemCard = document.createElement('div');
                    itemCard.className = 'bg-card rounded-lg shadow-lg overflow-hidden flex flex-col transition-transform duration-200 hover:scale-[1.02] cursor-pointer';
                    itemCard.dataset.id = item.id; // For opening modal
                    itemCard.innerHTML = `
                        <div class="p-5 flex-grow">
                            <div class="flex justify-between items-start mb-2">
                                <h3 class="text-xl font-bold font-heading text-primary">${item.name}</h3>
                                <span class="ml-2 mt-1">
                                    <img src="${item.veg ? 'https://upload.wikimedia.org/wikipedia/commons/thumb/b/b2/Veg_symbol.svg/1200px-Veg_symbol.svg.png' : 'https://upload.wikimedia.org/wikipedia/commons/thumb/b/ba/Non_Veg_symbol.svg/1200px-Non_Veg_symbol.svg.png'}" alt="${item.veg ? 'Veg' : 'Non-Veg'}" class="w-5 h-5">
                                </span>
                            </div>
                            <p class="text-main mb-4 text-sm">${item.description}</p>
                        </div>
                        <div class="p-5 bg-gray-50 bg-opacity-50 flex justify-between items-center">
                            <span class="text-xl font-bold text-primary">₹${item.price.toFixed(2)}</span>
                            <button class="add-to-cart-btn px-4 py-2 rounded-lg btn-secondary font-semibold text-sm" data-id="${item.id}">
                                Add
                            </button>
                        </div>
                    `;
                    menuItemsGrid.appendChild(itemCard);
                });
                
                // 3. Add Event Listeners
                menuItemsGrid.querySelectorAll('.add-to-cart-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        e.stopPropagation(); // Prevent modal from opening
                        addToCart(parseInt(button.dataset.id));
                    });
                });
                menuItemsGrid.querySelectorAll('.bg-card').forEach(card => {
                    card.addEventListener('click', () => {
                        openMenuItemModal(parseInt(card.dataset.id));
                    });
                });
                
                lucide.createIcons();
            }
            
            // NEW: Render Recommended Items
            function renderRecommendedItems() {
                const recommended = menuData.filter(item => item.popular).slice(0, 4);
                recommendationsContainer.innerHTML = '';
                recommended.forEach(item => {
                    const card = document.createElement('div');
                    card.className = 'flex-shrink-0 w-64 bg-card rounded-lg shadow-lg overflow-hidden cursor-pointer';
                    card.dataset.id = item.id;
                    card.innerHTML = `
                        <img src="https://placehold.co/300x200/${varToHex(currentTheme === 'dark' ? '--bg-color' : '--primary-color')}/FFFFFF?text=${encodeURIComponent(item.name)}" class="w-full h-32 object-cover" alt="${item.name}">
                        <div class="p-4">
                            <h4 class="font-bold font-heading text-lg text-primary truncate">${item.name}</h4>
                            <p class="text-sm text-main truncate">${item.description}</p>
                            <div class="flex justify-between items-center mt-3">
                                <span class="font-bold text-primary">₹${item.price.toFixed(2)}</span>
                                <button class="add-to-cart-btn px-3 py-1 rounded-lg btn-secondary font-semibold text-xs" data-id="${item.id}">
                                    Add
                                </button>
                            </div>
                        </div>
                    `;
                    card.addEventListener('click', (e) => {
                        if (!e.target.classList.contains('add-to-cart-btn')) {
                            openMenuItemModal(item.id);
                        }
                    });
                    card.querySelector('.add-to-cart-btn').addEventListener('click', (e) => {
                        e.stopPropagation();
                        addToCart(item.id);
                    });
                    recommendationsContainer.appendChild(card);
                });
            }

            // NEW: Render Testimonials
            function renderTestimonials() {
                testimonialContainer.innerHTML = '';
                testimonials.forEach((testimonial, index) => {
                    const slide = document.createElement('div');
                    slide.className = 'testimonial-slide absolute w-full text-center p-4 opacity-0';
                    if (index === 0) slide.classList.add('opacity-100');
                    slide.innerHTML = `
                        <p class="text-xl italic text-main mb-4">"${testimonial.quote}"</p>
                        <h4 class="font-bold font-heading text-lg text-primary">- ${testimonial.name}</h4>
                    `;
                    testimonialContainer.appendChild(slide);
                });
                
                updateTestimonialDots();
                
                // Start slider
                if (testimonialInterval) clearInterval(testimonialInterval);
                testimonialInterval = setInterval(nextTestimonial, 5000);
            }
            
            function nextTestimonial() {
                const slides = document.querySelectorAll('.testimonial-slide');
                slides[currentTestimonial].classList.remove('opacity-100');
                currentTestimonial = (currentTestimonial + 1) % slides.length;
                slides[currentTestimonial].classList.add('opacity-100');
                updateTestimonialDots();
            }
            
            function updateTestimonialDots() {
                document.querySelectorAll('.testimonial-dot').forEach((dot, index) => {
                    dot.classList.toggle('bg-primary', index === currentTestimonial);
                    dot.classList.toggle('bg-gray-300', index !== currentTestimonial);
                });
            }

            // --- Cart Functions ---
            function addToCart(itemId, fromModal = false) {
                // ... (Original addToCart logic)
                const item = menuData.find(i => i.id === itemId);
                if (!item) return;

                const existingItem = cart.find(i => i.id === itemId);
                
                if (existingItem) {
                    existingItem.quantity++;
                } else {
                    cart.push({ id: item.id, name: item.name, price: item.price, quantity: 1, veg: item.veg });
                }
                
                updateCart();
                animateCartIcon();
                showMessage('Added to Cart', `${item.name} was added to your order.`, 'success');
                
                if (fromModal) {
                    menuItemModal.classList.add('hidden');
                }
            }

            function updateCart(fromStorage = false) {
                // ... (Original updateCart logic, with additions)
                
                // Reset redeemed points on every update, they are re-applied
                if (!fromStorage) {
                    pointsRedeemed = 0;
                }

                // 1. Update UI (Modal)
                if (cart.length === 0) {
                    // ... (original empty cart logic)
                    emptyCartMessage.classList.remove('hidden');
                    cartItemsContainer.innerHTML = '';
                    cartFooter.classList.add('hidden');
                } else {
                    // ... (original cart items logic)
                    emptyCartMessage.classList.add('hidden');
                    cartFooter.classList.remove('hidden');
                    cartItemsContainer.innerHTML = '';
                    
                    cart.forEach(item => {
                        const itemEl = document.createElement('div');
                        itemEl.className = 'flex items-center justify-between py-4 border-b border-gray-200';
                        itemEl.innerHTML = `
                            <div class="flex-grow pr-4">
                                <div class="flex items-center mb-1">
                                    <img src="${item.veg ? 'https://upload.wikimedia.org/wikipedia/commons/thumb/b/b2/Veg_symbol.svg/1200px-Veg_symbol.svg.png' : 'https://upload.wikimedia.org/wikipedia/commons/thumb/b/ba/Non_Veg_symbol.svg/1200px-Non_Veg_symbol.svg.png'}" alt="${item.veg ? 'Veg' : 'Non-Veg'}" class="w-4 h-4 mr-2">
                                    <h4 class="font-semibold text-main">${item.name}</h4>
                                </div>
                                <p class="text-sm text-gray-500">₹${item.price.toFixed(2)}</p>
                            </div>
                            <div class="flex items-center space-x-2">
                                <button class="quantity-change-btn p-1 rounded-full btn-ghost-secondary" data-id="${item.id}" data-change="-1">
                                    <i data-lucide="minus" class="w-4 h-4"></i>
                                </button>
                                <span class="font-bold w-6 text-center">${item.quantity}</span>
                                <button class="quantity-change-btn p-1 rounded-full btn-ghost-secondary" data-id="${item.id}" data-change="1">
                                    <i data-lucide="plus" class="w-4 h-4"></i>
                                </button>
                            </div>
                        `;
                        cartItemsContainer.appendChild(itemEl);
                    });
                }
                
                // 2. Update Totals
                const subtotal = cart.reduce((acc, item) => acc + (item.price * item.quantity), 0);
                
                // Handle Discounts
                let discountAmount = 0;
                if (spinDiscount) {
                    discountAmount = (subtotal * spinDiscount.value) / 100;
                    discountAppliedSection.classList.remove('hidden');
                    discountTextEl.textContent = `${spinDiscount.text} Discount!`;
                    discountAmountDisplayEl.textContent = `- ₹${discountAmount.toFixed(2)}`;
                } else {
                    discountAppliedSection.classList.add('hidden');
                }
                
                // NEW: Handle Loyalty Points
                // Ensure redeemed points don't exceed subtotal minus other discounts
                let availableForRedemption = subtotal - discountAmount;
                let redemptionAmount = Math.min(loyaltyPoints, pointsRedeemed, availableForRedemption);
                pointsRedeemed = redemptionAmount; // Update state

                if (pointsRedeemed > 0) {
                    pointsRedeemedSection.classList.remove('hidden');
                    pointsRedeemedAmountDisplay.textContent = `- ₹${pointsRedeemed.toFixed(2)}`;
                } else {
                    pointsRedeemedSection.classList.add('hidden');
                }
                
                // Show/hide redeem button
                if (cart.length > 0 && loyaltyPoints > 0 && pointsRedeemed === 0) {
                    loyaltyRedeemSection.classList.remove('hidden');
                    let redeemableValue = Math.min(loyaltyPoints, availableForRedemption);
                    redeemPointsAvailable.textContent = loyaltyPoints;
                    redeemPointsValue.textContent = `₹${redeemableValue.toFixed(0)}`;
                    redeemPointsBtn.disabled = redeemableValue <= 0;
                } else {
                    loyaltyRedeemSection.classList.add('hidden');
                }

                // Calculate final total
                const taxes = (subtotal - discountAmount - pointsRedeemed) * 0.05; // 5% GST
                const total = subtotal - discountAmount - pointsRedeemed + taxes;
                
                cartSubtotalEl.textContent = `₹${subtotal.toFixed(2)}`;
                cartTaxesEl.textContent = `₹${taxes.toFixed(2)}`;
                cartTotalEl.textContent = `₹${total.toFixed(2)}`;
                
                // 3. Update Badges
                // ... (original badge logic)
                const totalItems = cart.reduce((acc, item) => acc + item.quantity, 0);
                cartCountBadges.forEach(badge => {
                    badge.textContent = totalItems;
                    badge.classList.toggle('hidden', totalItems === 0);
                });
                
                // 4. Update Local Storage
                if (!fromStorage) {
                    saveState();
                }

                // 5. Re-add lucide icons
                lucide.createIcons();
            }

            function changeQuantity(itemId, change) {
                // ... (Original changeQuantity function)
                const item = cart.find(i => i.id === itemId);
                if (!item) return;
                
                item.quantity += change;
                
                if (item.quantity <= 0) {
                    cart = cart.filter(i => i.id !== itemId);
                }
                
                updateCart();
            }
            
            // NEW: Redeem Loyalty Points
            function redeemPoints() {
                const subtotal = cart.reduce((acc, item) => acc + (item.price * item.quantity), 0);
                let discountAmount = 0;
                if (spinDiscount) {
                    discountAmount = (subtotal * spinDiscount.value) / 100;
                }
                let availableForRedemption = subtotal - discountAmount;
                
                // Redeem all available points up to the redeemable amount
                pointsRedeemed = Math.min(loyaltyPoints, availableForRedemption); 
                
                if (pointsRedeemed > 0) {
                    showMessage('Points Redeemed!', `You've used ${pointsRedeemed.toFixed(0)} points for a ₹${pointsRedeemed.toFixed(2)} discount.`, 'success');
                }
                
                updateCart(); // Re-calculate totals
            }

            function animateCartIcon() {
                // ... (Original animateCartIcon function)
                const icons = [cartButton, mobileCartButton];
                icons.forEach(icon => {
                    icon.classList.add('cart-bump');
                    icon.addEventListener('animationend', () => {
                        icon.classList.remove('cart-bump');
                    }, { once: true });
                });
            }

            function toggleCartModal() {
                // ... (Original toggleCartModal function)
                cartModal.classList.toggle('hidden');
                if (!cartModal.classList.contains('hidden')) {
                    // Reset redeemed points every time cart is opened
                    pointsRedeemed = 0;
                    updateCart();
                }
            }

            function updateOrderType(type) {
                // ... (Original updateOrderType function)
                orderType = type;
                updateOrderTypeUI();
                saveState();
            }

            function updateOrderTypeUI() {
                // ... (Original updateOrderTypeUI function)
                if (orderType === 'Dine-In') {
                    orderTypeDineInBtn.classList.add('bg-primary', 'text-primary-contrast', 'shadow');
                    orderTypeDineInBtn.classList.remove('text-gray-700');
                    orderTypeTakeawayBtn.classList.remove('bg-primary', 'text-primary-contrast', 'shadow');
                    orderTypeTakeawayBtn.classList.add('text-gray-700');
                } else {
                    orderTypeTakeawayBtn.classList.add('bg-primary', 'text-primary-contrast', 'shadow');
                    orderTypeTakeawayBtn.classList.remove('text-gray-700');
                    orderTypeDineInBtn.classList.remove('bg-primary', 'text-primary-contrast', 'shadow');
                    orderTypeDineInBtn.classList.add('text-gray-700');
                }
            }

            // --- Game Center Functions ---
            function renderSpinWheel() {
                // ... (Original renderSpinWheel function)
                spinWheel.innerHTML = '';
                const sliceAngle = 360 / spinWheelSegments.length;
                
                spinWheelSegments.forEach((segment, i) => {
                    const slice = document.createElement('div');
                    slice.className = 'absolute w-full h-full';
                    slice.style.transform = `rotate(${sliceAngle * i}deg)`;
                    
                    const angleRad = (sliceAngle * Math.PI) / 180;
                    const x = Math.tan(angleRad / 2) * 50 + 50;
                    slice.style.clipPath = `polygon(50% 50%, 50% 0, ${x}% 0, 50% 50%)`;

                    const sliceContent = document.createElement('div');
                    sliceContent.className = 'absolute w-full h-full flex items-start justify-center';
                    sliceContent.style.backgroundColor = segmentColors[i % segmentColors.length];
                    
                    const label = document.createElement('span');
                    label.className = 'font-bold text-white text-sm sm:text-base mt-4';
                    label.textContent = segment.label;
                    label.style.transform = `rotate(${sliceAngle / 2}deg) translate(0, -5px)`;
                    // Try to get contrast color from CSS var
                    label.style.color = 'var(--primary-text-color, #FFFFFF)'; 
                    
                    sliceContent.appendChild(label);
                    slice.appendChild(sliceContent);
                    spinWheel.appendChild(slice);
                });
            }
            
            function openGameCenter() {
                // ... (Original openGameCenter function)
                if (spinDiscount) {
                    alreadySpun.classList.remove('hidden');
                    existingDiscountText.textContent = spinDiscount.text;
                    spinBtn.classList.add('hidden');
                    spinResult.classList.add('hidden');
                } else {
                    alreadySpun.classList.add('hidden');
                    spinBtn.classList.remove('hidden');
                    spinResult.classList.add('hidden');
                    spinBtn.disabled = false;
                    spinBtn.textContent = 'Spin Now!';
                }
                gameCenterModal.classList.remove('hidden');
            }
            
            function closeGameCenter() {
                // ... (Original closeGameCenter function)
                gameCenterModal.classList.add('hidden');
            }
            
            function startSpin() {
                // ... (Original startSpin function)
                if (isSpinning || spinDiscount) return;
                
                isSpinning = true;
                spinBtn.disabled = true;
                spinBtn.textContent = 'Spinning...';
                spinResult.classList.add('hidden');
                
                const winningIndex = Math.floor(Math.random() * spinWheelSegments.length);
                const winningSegment = spinWheelSegments[winningIndex];
                
                const sliceAngle = 360 / spinWheelSegments.length;
                const randomOffset = (Math.random() - 0.5) * sliceAngle * 0.8; 
                const targetAngle = (360 - (winningIndex * sliceAngle) - (sliceAngle / 2)) + randomOffset;
                const totalRotation = 360 * 5 + targetAngle;
                
                spinWheel.style.transform = `rotate(${totalRotation}deg)`;
                
                setTimeout(() => {
                    isSpinning = false;
                    spinBtn.disabled = false;
                    
                    if (winningSegment.value > 0) {
                        spinDiscount = { value: winningSegment.value, text: winningSegment.label };
                        resultText.textContent = winningSegment.label;
                        spinResult.classList.remove('hidden', 'result-pop');
                        void spinResult.offsetWidth; 
                        spinResult.classList.add('result-pop');
                        spinBtn.classList.add('hidden');
                        
                        showMessage('You Won!', `A ${spinDiscount.text} discount has been applied.`, 'success');
                        updateCart();
                    } else {
                        resultText.textContent = "Try Again!";
                        spinResult.classList.remove('hidden', 'result-pop');
                        void spinResult.offsetWidth; 
                        spinResult.classList.add('result-pop');
                        spinBtn.textContent = 'Spin Again!';
                        spinBtn.disabled = false;
                        showMessage('Better luck next time!', 'You can spin the wheel again.', 'info');
                    }
                    saveState();
                }, 5100); 
            }
            
            // --- NEW: Item Modal Functions ---
            function openMenuItemModal(itemId) {
                const item = menuData.find(i => i.id === itemId);
                if (!item) return;
                
                menuItemModalImg.src = `https://placehold.co/600x400/${varToHex(currentTheme === 'dark' ? '--bg-color' : '--primary-color')}/FFFFFF?text=${encodeURIComponent(item.name)}`;
                menuItemModalName.textContent = item.name;
                menuItemModalDesc.textContent = item.description;
                menuItemModalPrice.textContent = `₹${item.price.toFixed(2)}`;
                menuItemModalVeg.src = item.veg ? 'https://upload.wikimedia.org/wikipedia/commons/thumb/b/b2/Veg_symbol.svg/1200px-Veg_symbol.svg.png' : 'https://upload.wikimedia.org/wikipedia/commons/thumb/b/ba/Non_Veg_symbol.svg/1200px-Non_Veg_symbol.svg.png';
                
                // Update favorite button
                menuItemModalFavBtn.classList.toggle('favorited', favorites.includes(item.id));
                menuItemModalFavBtn.dataset.id = item.id;
                
                // Update add button
                menuItemModalAddBtn.dataset.id = item.id;
                
                menuItemModal.classList.remove('hidden');
            }
            
            function toggleFavorite(itemId) {
                const heartIcon = menuItemModalFavBtn.querySelector('.heart-icon');
                if (favorites.includes(itemId)) {
                    favorites = favorites.filter(id => id !== itemId);
                    heartIcon.classList.remove('favorited');
                } else {
                    favorites.push(itemId);
                    heartIcon.classList.add('favorited');
                }
                saveState();
                // If user is in Favorites category, re-filter
                if (currentCategory === 'Favorites') {
                    filterMenu();
                }
            }

            // --- NEW: Quick Order Modal ---
            function openQuickOrderModal() {
                const popularItems = menuData.filter(i => i.popular).slice(0, 5);
                quickOrderBody.innerHTML = '';
                popularItems.forEach(item => {
                    const itemEl = document.createElement('div');
                    itemEl.className = 'flex items-center justify-between p-3 bg-gray-50 rounded-lg';
                    itemEl.innerHTML = `
                        <div>
                            <h4 class="font-semibold text-main">${item.name}</h4>
                            <p class="text-sm text-primary font-bold">₹${item.price.toFixed(2)}</p>
                        </div>
                        <button class="add-to-cart-btn px-4 py-2 rounded-lg btn-secondary font-semibold text-sm" data-id="${item.id}">
                            Add
                        </button>
                    `;
                    quickOrderBody.appendChild(itemEl);
                });
                
                // Add listeners
                quickOrderBody.querySelectorAll('.add-to-cart-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        addToCart(parseInt(btn.dataset.id));
                    });
                });
                
                quickOrderModal.classList.remove('hidden');
            }

            // --- NEW: Booking Modal ---
            async function handleBookingSubmit(e) {
                e.preventDefault();
                const name = bookingForm.querySelector('#book-name').value;
                const phone = bookingForm.querySelector('#book-phone').value;
                const guests = bookingForm.querySelector('#book-guests').value;
                const date = bookingForm.querySelector('#book-date').value;
                
                const bookingData = {
                    name,
                    phone,
                    guests: parseInt(guests),
                    date,
                    created_at: new Date().toISOString()
                };
                
                // --- Try to save to Supabase ---
                let success = false;
                if (supabase) {
                    try {
                        // Assuming you have a table named 'bookings'
                        const { data, error } = await supabase
                            .from('bookings')
                            .insert([bookingData]);
                            
                        if (error) throw error;
                        
                        console.log('Booking saved to Supabase:', data);
                        success = true;
                    } catch (error) {
                        console.error('Supabase booking error:', error.message);
                        // Fallback to console log
                        console.log('Booking Request (local):', bookingData);
                    }
                } else {
                    // Fallback if supabase failed to init
                    console.log('Booking Request (local):', bookingData);
                }

                if (success) {
                    showMessage('Booking Received!', 'We have received your request and will call to confirm.', 'success');
                } else {
                     showMessage('Request Logged', 'Your booking request has been logged locally.', 'info');
                }
                
                bookingForm.reset();
                bookingModal.classList.add('hidden');
            }

            // --- NEW: Loyalty Functions ---
            function updateLoyaltyDisplay() {
                loyaltyPointsDisplays.forEach(el => el.textContent = loyaltyPoints.toFixed(0));
                loyaltyModalPoints.textContent = loyaltyPoints.toFixed(0);
            }

            function addLoyaltyPoints(subtotal) {
                // 10 points per ₹100
                const pointsEarned = Math.floor(subtotal / 100) * 10;
                if (pointsEarned > 0) {
                    loyaltyPoints += pointsEarned;
                    updateLoyaltyDisplay();
                    saveState();
                    return pointsEarned; // Return for message
                }
                return 0;
            }

            // --- Message/Toast Function ---
            function showMessage(title, body, type = 'success') {
                // ... (Original showMessage function)
                if (messageTimer) clearTimeout(messageTimer);
                messageTitle.textContent = title;
                messageBody.textContent = body;
                
                messageModal.classList.remove('border-green-500', 'border-red-500', 'border-blue-500');
                messageIconContainer.innerHTML = '';
                
                let iconHtml = '';
                let borderColor = '';
                let titleColor = '';

                switch (type) {
                    case 'error':
                        iconHtml = `<i data-lucide="alert-circle" class="w-6 h-6 text-red-500"></i>`;
                        borderColor = 'border-red-500';
                        titleColor = 'text-red-700';
                        break;
                    case 'info':
                        iconHtml = `<i data-lucide="info" class="w-6 h-6 text-blue-500"></i>`;
                        borderColor = 'border-blue-500';
                        titleColor = 'text-blue-700';
                        break;
                    case 'success':
                    default:
                        iconHtml = `<i data-lucide="check-circle" class="w-6 h-6 text-green-500"></i>`;
                        borderColor = 'border-green-500';
                        titleColor = 'text-green-700';
                        break;
                }
                
                messageIconContainer.innerHTML = iconHtml;
                messageModal.classList.add(borderColor);
                messageTitle.classList.remove('text-red-700', 'text-blue-700', 'text-green-700'); // Reset first
                messageTitle.classList.add(titleColor);
                lucide.createIcons();
                
                messageModal.classList.remove('translate-x-[150%]');
                
                messageTimer = setTimeout(() => {
                    hideMessage();
                }, 4000);
            }
            
            function hideMessage() {
                // ... (Original hideMessage function)
                if (messageTimer) clearTimeout(messageTimer);
                messageModal.classList.add('translate-x-[150%]');
            }

            // --- Local Storage ---
            function saveState() {
                try {
                    localStorage.setItem('pankhCart', JSON.stringify(cart));
                    localStorage.setItem('pankhOrderType', orderType);
                    localStorage.setItem('pankhLoyaltyPoints', loyaltyPoints.toString());
                    localStorage.setItem('pankhFavorites', JSON.stringify(favorites));
                    
                    if (spinDiscount) {
                        localStorage.setItem('pankhDiscount', JSON.stringify(spinDiscount));
                    } else {
                        localStorage.removeItem('pankhDiscount');
                    }
                } catch (e) {
                    console.error("Error saving state to local storage:", e);
                    showMessage('Save Error', 'Could not save your app data.', 'error');
                }
            }
            
            function loadState() {
                applyTheme(localStorage.getItem('pankhTheme') || 'teal');
                
                try {
                    cart = JSON.parse(localStorage.getItem('pankhCart') || '[]');
                    const storedDiscount = localStorage.getItem('pankhDiscount');
                    if (storedDiscount) spinDiscount = JSON.parse(storedDiscount);
                    
                    orderType = localStorage.getItem('pankhOrderType') || 'Dine-In';
                    updateOrderTypeUI();
                    
                    loyaltyPoints = parseInt(localStorage.getItem('pankhLoyaltyPoints') || '0');
                    updateLoyaltyDisplay();

                    favorites = JSON.parse(localStorage.getItem('pankhFavorites') || '[]');

                } catch (e) {
                    console.error("Error loading state from local storage:", e);
                    localStorage.clear(); // Clear bad data
                }

                if (localStorage.getItem('pankhIntroPlayed') !== 'true') {
                    localStorage.setItem('pankhIntroPlayed', 'true');
                } else {
                    introVideoSection.style.display = 'none';
                }

                renderMenu();
                updateCart(true); // Pass true to prevent re-saving
            }

            // --- Helper ---
            function varToHex(varName) {
                // Gets the hex code from a CSS variable
                let color = getComputedStyle(document.documentElement).getPropertyValue(varName).trim();
                // Handle theme color names
                if (!color.startsWith('#')) {
                    // This is a basic fallback. Real conversion is complex.
                    // For this app, we know our vars are hex.
                    return '0F766E'; // Default to primary
                }
                return color.substring(1);
            }
            
            // --- Event Listeners ---
            function setupEventListeners() {
                // Intro Video
                introVideoSection.addEventListener('click', playIntro);
                
                // Nav
                [cartButton, mobileCartButton, closeCartBtn].forEach(btn => {
                    btn.addEventListener('click', toggleCartModal);
                });
                
                // Mobile Menu
                mobileMenuButton.addEventListener('click', () => {
                    mobileMenu.classList.toggle('hidden');
                    mobileMenuOpenIcon.classList.toggle('hidden');
                    mobileMenuCloseIcon.classList.toggle('hidden');
                });
                
                document.querySelectorAll('#mobile-menu a').forEach(link => {
                    link.addEventListener('click', () => {
                        mobileMenu.classList.add('hidden');
                        mobileMenuOpenIcon.classList.remove('hidden');
                        mobileMenuCloseIcon.classList.add('hidden');
                    });
                });

                // NEW: Menu Filtering
                categorySelect.addEventListener('change', (e) => setCategory(e.target.value));
                menuSearchInput.addEventListener('input', filterMenu);
                
                // Cart
                cartItemsContainer.addEventListener('click', (e) => {
                    const btn = e.target.closest('.quantity-change-btn');
                    if (btn) {
                        changeQuantity(parseInt(btn.dataset.id), parseInt(btn.dataset.change));
                    }
                });
                redeemPointsBtn.addEventListener('click', redeemPoints);

                // Order Type
                orderTypeDineInBtn.addEventListener('click', () => updateOrderType('Dine-In'));
                orderTypeTakeawayBtn.addEventListener('click', () => updateOrderType('Takeaway'));
                
                // Game Center
                gameCenterBtn.addEventListener('click', openGameCenter);
                closeGameCenterBtn.addEventListener('click', closeGameCenter);
                spinBtn.addEventListener('click', startSpin);
                
                // NEW: Loyalty Modal
                loyaltyButtons.forEach(btn => btn.addEventListener('click', () => {
                    updateLoyaltyDisplay(); // Refresh points
                    loyaltyModal.classList.remove('hidden');
                }));
                closeLoyaltyBtn.addEventListener('click', () => loyaltyModal.classList.add('hidden'));

                // NEW: Settings Modal
                settingsButtons.forEach(btn => btn.addEventListener('click', () => settingsModal.classList.remove('hidden')));
                closeSettingsBtn.addEventListener('click', () => settingsModal.classList.add('hidden'));
                themeToggleBtn.addEventListener('click', toggleTheme);
                
                // NEW: Booking Modal
                openBookingBtn.addEventListener('click', () => bookingModal.classList.remove('hidden'));
                closeBookingBtn.addEventListener('click', () => bookingModal.classList.add('hidden'));
                bookingForm.addEventListener('submit', handleBookingSubmit);
                // Set min date for booking
                document.getElementById('book-date').min = new Date().toISOString().split("T")[0];
                
                // NEW: Quick Order Modal
                openQuickOrderBtn.addEventListener('click', openQuickOrderModal);
                closeQuickOrderBtn.addEventListener('click', () => quickOrderModal.classList.add('hidden'));
                
                // NEW: Menu Item Modal
                closeMenuItemBtn.addEventListener('click', () => menuItemModal.classList.add('hidden'));
                menuItemModalFavBtn.addEventListener('click', (e) => {
                    toggleFavorite(parseInt(e.currentTarget.dataset.id));
                });
                menuItemModalAddBtn.addEventListener('click', (e) => {
                    addToCart(parseInt(e.currentTarget.dataset.id), true);
                });

                // Message Modal
                closeMessageBtn.addEventListener('click', hideMessage);
                
                // Checkout
                checkoutBtn.addEventListener('click', () => {
                    if (cart.length > 0) {
                        const subtotal = cart.reduce((acc, item) => acc + (item.price * item.quantity), 0);
                        
                        // 1. Finalize loyalty points
                        loyaltyPoints -= pointsRedeemed; // Subtract redeemed
                        const pointsEarned = addLoyaltyPoints(subtotal); // Add new
                        
                        // 2. Log order
                        console.log("Placing order:", {
                            cart,
                            orderType,
                            total: cartTotalEl.textContent,
                            discount: spinDiscount,
                            pointsRedeemed: pointsRedeemed,
                            pointsEarned: pointsEarned
                        });
                        
                        // 3. Show success
                        let successMsg = `You earned ${pointsEarned} points!`;
                        if (pointsRedeemed > 0) {
                            successMsg = `You redeemed ${pointsRedeemed.toFixed(0)} points and earned ${pointsEarned}.`;
                        }
                        showMessage('Order Placed!', `Your order is sent. ${successMsg}`, 'success');
                        
                        // 4. Clear cart
                        cart = [];
                        spinDiscount = null; // Clear discount after order
                        pointsRedeemed = 0; // Clear redeemed
                        updateCart();
                        saveState(); // Save empty/updated state
                        
                        // 5. Close cart
                        setTimeout(toggleCartModal, 1500);
                        
                    } else {
                        showMessage('Empty Cart', 'Please add items to your cart.', 'error');
                    }
                });
            }

            // --- Initialization ---
            function initApp() {
                lucide.createIcons();
                document.getElementById('footer-year').textContent = new Date().getFullYear();
                
                loadState(); // This calls renderMenu() and updateCart()
                
                // Render new components
                renderThemePicker();
                renderRecommendedItems();
                renderTestimonials();
                renderSpinWheel();
                
                setupEventListeners();
            }
            
            initApp();
        });
    </script>
</body>
</html>

